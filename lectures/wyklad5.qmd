---
title: "Mechanizmy zapewniania spÃ³jnoÅ›ci danych i wprowadzenie do widokÃ³w"
---

## 1ï¸âƒ£ Transakcje i ich wÅ‚aÅ›ciwoÅ›ci (ACID)

### ğŸ”¹ Co to jest transakcja?

Transakcja to logiczna jednostka pracy w bazie danych, skÅ‚adajÄ…ca siÄ™ z jednej lub wielu operacji (INSERT, UPDATE, DELETE, itp.), ktÃ³re powinny byÄ‡ wykonane caÅ‚oÅ›ciowo.

Transakcja to zbiÃ³r operacji, ktÃ³re albo wszystkie siÄ™ powiodÄ…, albo Å¼adna â€“ nie ma stanu poÅ›redniego.

PrzykÅ‚ad:
```sql
BEGIN;
UPDATE Konta SET Saldo = Saldo - 100 WHERE NrKonta = 101;
UPDATE Konta SET Saldo = Saldo + 100 WHERE NrKonta = 202;
COMMIT;
```

â¡ï¸ JeÅ›li obie aktualizacje siÄ™ powiodÄ… â€“ zmiany zostanÄ… zatwierdzone (COMMIT).

â¡ï¸ JeÅ›li jedna z operacji siÄ™ nie uda â€“ baza moÅ¼e przywrÃ³ciÄ‡ stan sprzed transakcji (ROLLBACK).


### ğŸ”¹ Operacje sterujÄ…ce transakcjÄ…

- BEGIN / START TRANSACTION â€“ rozpoczÄ™cie transakcji,
- COMMIT â€“ zatwierdzenie zmian,
- ROLLBACK â€“ cofniÄ™cie zmian do stanu poczÄ…tkowego,
- SAVEPOINT â€“ ustawienie punktu czÄ™Å›ciowego cofniÄ™cia.

```sql
BEGIN;
INSERT INTO Studenci VALUES (1001, 'Anna', 'Nowak', 22);
SAVEPOINT p1;
UPDATE Studenci SET Wiek = 23 WHERE NrIndeksu = 1001;
ROLLBACK TO SAVEPOINT p1;
COMMIT;
```
â¡ï¸ Zmieniono wiek Anny, ale cofniÄ™to tylko ostatniÄ… operacjÄ™ (ROLLBACK TO p1).

â¡ï¸ Wstawienie rekordu pozostaÅ‚o


## 2ï¸âƒ£ WspÃ³Å‚bieÅ¼noÅ›Ä‡ i problemy spÃ³jnoÅ›ci

### ğŸ”¹ Co to jest wspÃ³Å‚bieÅ¼noÅ›Ä‡?

WspÃ³Å‚bieÅ¼noÅ›Ä‡ (ang. concurrency) to sytuacja, gdy wiele transakcji wykonuje siÄ™ jednoczeÅ›nie na tej samej bazie danych.

DziÄ™ki wspÃ³Å‚bieÅ¼noÅ›ci baza moÅ¼e obsÅ‚ugiwaÄ‡ wielu uÅ¼ytkownikÃ³w naraz, aleâ€¦

â¡ï¸ moÅ¼e dojÅ›Ä‡ do konfliktÃ³w, jeÅ›li transakcje modyfikujÄ… te same dane.

### ğŸ”¹ PrzykÅ‚ad konfliktu wspÃ³Å‚bieÅ¼noÅ›ci

Transakcja 1
```sql
BEGIN;
UPDATE Konto SET Saldo = Saldo - 500 WHERE ID = 1;
```

Transakcja 2
```sql
BEGIN;
UPDATE Konto SET Saldo = Saldo - 300 WHERE ID = 1;

```

Obie modyfikujÄ… ten sam rekord.
JeÅ›li system nie zapewni izolacji â€” saldo koÅ„cowe moÅ¼e byÄ‡ bÅ‚Ä™dne.


## 3ï¸âƒ£ Poziomy izolacji transakcji

Bazy danych zapewniajÄ… rÃ³Å¼ne poziomy izolacji, ktÃ³re rÃ³wnowaÅ¼Ä… spÃ³jnoÅ›Ä‡ danych i wydajnoÅ›Ä‡.

### ğŸ”¹ PrzykÅ‚ad w PostgreSQL:

```sql
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM Zamowienia WHERE KlientID = 10;
-- Inna transakcja modyfikuje dane
SELECT * FROM Zamowienia WHERE KlientID = 10;
COMMIT;

```

â¡ï¸ Na poziomie REPEATABLE READ oba SELECT-y zobaczÄ… ten sam zestaw danych, nawet jeÅ›li inna transakcja je zmieniÅ‚a w miÄ™dzyczasie.



# 1ï¸âƒ£3ï¸âƒ£ Podzapytania (Subqueries) w SQL

Podzapytanie to **zapytanie wewnÄ…trz innego zapytania SQL**. 
SÅ‚uÅ¼y do wykonywania bardziej zÅ‚oÅ¼onych operacji, kiedy jedno zapytanie potrzebuje wynikÃ³w innego.  
MoÅ¼emy je traktowaÄ‡ jak â€mini-zapytaniaâ€, ktÃ³re dostarczajÄ… danych do zapytania gÅ‚Ã³wnego.

Podzapytania mogÄ… wystÄ™powaÄ‡ w rÃ³Å¼nych miejscach:

- w klauzuli **WHERE** â€“ do filtrowania danych,
- w klauzuli **FROM** â€“ jako tymczasowa tabela,
- w klauzuli **SELECT** â€“ do obliczeÅ„ w kaÅ¼dej krotce,
- w konstrukcjach **EXISTS**, **IN**, **ALL**, **ANY** â€“ do testowania warunkÃ³w logicznych.


## ğŸ”¹ 1. Podzapytanie w klauzuli WHERE (jednowartoÅ›ciowe)

To najczÄ™stszy typ podzapytania.  
Zapytanie gÅ‚Ã³wne wybiera dane na podstawie **wartoÅ›ci zwrÃ³conej przez podzapytanie**.

### ğŸ§© PrzykÅ‚ad:

ZnajdÅº ksiÄ…Å¼ki napisane przez autora o nazwisku *Sienkiewicz*.

```sql
SELECT tytul, rok
FROM Ksiazki
WHERE autor_id = (
    SELECT autor_id
    FROM Autorzy
    WHERE nazwisko = 'Sienkiewicz'
);
```

### ğŸ“˜ Opis dziaÅ‚ania:

1.	Podzapytanie wewnÄ™trzne szuka identyfikatora autora autor_id, ktÃ³rego nazwisko to Sienkiewicz.
2.	Zapytanie gÅ‚Ã³wne wybiera z tabeli Ksiazki tylko te rekordy, w ktÃ³rych autor_id jest rÃ³wny wynikowi podzapytania.

> ğŸ”¸ Takie podzapytanie musi zwrÃ³ciÄ‡ jednÄ… wartoÅ›Ä‡ (scalar subquery) â€“ w przeciwnym razie wystÄ…pi bÅ‚Ä…d.

## ğŸ”¹ 2. Podzapytanie zwracajÄ…ce wiele wartoÅ›ci (operator IN)

JeÅ›li podzapytanie zwraca wiÄ™cej niÅ¼ jeden rekord, uÅ¼ywamy operatora IN.

### ğŸ§© PrzykÅ‚ad:

ZnajdÅº wszystkie ksiÄ…Å¼ki autorÃ³w, ktÃ³rych nazwiska zaczynajÄ… siÄ™ na literÄ™ M.

```sql
SELECT tytul, rok
FROM Ksiazki
WHERE autor_id IN (
    SELECT autor_id
    FROM Autorzy
    WHERE nazwisko LIKE 'M%'
);
```

### ğŸ“˜ Opis dziaÅ‚ania:

- Podzapytanie wewnÄ™trzne zwraca listÄ™ identyfikatorÃ³w autorÃ³w, np. [1, 5, 7].
- Zapytanie gÅ‚Ã³wne wybiera ksiÄ…Å¼ki, ktÃ³rych autor_id znajduje siÄ™ na tej liÅ›cie.

> ğŸ”¸ Operator IN moÅ¼na traktowaÄ‡ jak porÃ³wnanie z â€wieloma wartoÅ›ciami jednoczeÅ›nieâ€.


## ğŸ”¹ 3. Podzapytanie w klauzuli SELECT

Podzapytanie moÅ¼e teÅ¼ zwracaÄ‡ pojedynczÄ… wartoÅ›Ä‡ (skalarnÄ…) i byÄ‡ uÅ¼yte w liÅ›cie kolumn.

### ğŸ§© PrzykÅ‚ad:

WyÅ›wietl listÄ™ autorÃ³w wraz z liczbÄ… ich ksiÄ…Å¼ek.

```sql
SELECT
    a.imie,
    a.nazwisko,
    (
        SELECT COUNT(*)
        FROM Ksiazki k
        WHERE k.autor_id = a.autor_id
    ) AS liczba_ksiazek
FROM Autorzy a;

```

### ğŸ“˜ Opis dziaÅ‚ania:

- Dla kaÅ¼dego autora (a.autor_id) wykonuje siÄ™ osobne podzapytanie,
ktÃ³re liczy ksiÄ…Å¼ki przypisane do tego autora.
- Wynik jest dodawany jako nowa kolumna liczba_ksiazek.

> ğŸ”¸ To tzw. podzapytanie skorelowane (correlated subquery), poniewaÅ¼ odnosi siÄ™ do kolumny z zapytania gÅ‚Ã³wnego.

## ğŸ”¹ 4. Podzapytanie w klauzuli FROM (tabela pochodna)

Podzapytanie moÅ¼e tworzyÄ‡ tymczasowÄ… tabelÄ™ w sekcji FROM.
Takie rozwiÄ…zanie nazywa siÄ™ derived table i pozwala na pracÄ™ z przetworzonymi danymi.

### ğŸ§© PrzykÅ‚ad:

Policz Å›redni rok wydania ksiÄ…Å¼ek, a nastÄ™pnie wybierz te, ktÃ³re sÄ… starsze od Å›redniej.

```sql
SELECT tytul, rok
FROM (
    SELECT *
    FROM Ksiazki
) AS K
WHERE K.rok < (
    SELECT AVG(rok) FROM Ksiazki
);
```

### ğŸ“˜ Opis dziaÅ‚ania:

- Podzapytanie w FROM tworzy tymczasowÄ… tabelÄ™ K.
- W klauzuli WHERE uÅ¼ywamy innego podzapytania, ktÃ³re liczy Å›redni rok wydania.
- Wynik to ksiÄ…Å¼ki starsze od Å›redniej publikacji.

## ğŸ”¹ 5. Korelowane podzapytanie (correlated subquery)

To podzapytanie, ktÃ³re odwoÅ‚uje siÄ™ do kolumn z zapytania gÅ‚Ã³wnego.
Wykonuje siÄ™ dla kaÅ¼dego wiersza osobno â€“ dlatego bywa wolniejsze, ale bardzo elastyczne.

### ğŸ§© PrzykÅ‚ad:

ZnajdÅº najstarszÄ… ksiÄ…Å¼kÄ™ kaÅ¼dego autora.

```sql
SELECT k.tytul, k.rok, a.nazwisko
FROM Ksiazki k
JOIN Autorzy a ON k.autor_id = a.autor_id
WHERE k.rok = (
    SELECT MIN(rok)
    FROM Ksiazki
    WHERE autor_id = k.autor_id
);

```

### ğŸ“˜ Opis dziaÅ‚ania:

- Dla kaÅ¼dego wiersza w tabeli Ksiazki podzapytanie szuka najmniejszego roku dla tego samego autora.
- PorÃ³wnanie k.rok = (MIN(rok)) sprawia, Å¼e zostaje tylko najstarsza ksiÄ…Å¼ka kaÅ¼dego autora.

## ğŸ”¹ 6. Podzapytanie z EXISTS

Operator EXISTS sprawdza, czy podzapytanie zwrÃ³ciÅ‚o jakiekolwiek wiersze.
Nie liczy ich â€” interesuje nas jedynie, czy wynik istnieje (TRUE/FALSE).

### ğŸ§© PrzykÅ‚ad:

ZnajdÅº autorÃ³w, ktÃ³rzy napisali przynajmniej jednÄ… ksiÄ…Å¼kÄ™.
```sql
SELECT imie, nazwisko
FROM Autorzy a
WHERE EXISTS (
    SELECT 1
    FROM Ksiazki k
    WHERE k.autor_id = a.autor_id
);

```

### ğŸ“˜ Opis dziaÅ‚ania:

- Dla kaÅ¼dego autora sprawdzane jest, czy istnieje co najmniej jeden wiersz w tabeli Ksiazki z tym samym autor_id.
- JeÅ›li tak â€” warunek EXISTS zwraca TRUE, a autor pojawia siÄ™ w wyniku.


## ğŸ”¹ 7. PorÃ³wnania z ALL / ANY

Operator ALL wymaga, aby warunek byÅ‚ speÅ‚niony dla wszystkich wynikÃ³w podzapytania.
Operator ANY (lub SOME) â€“ aby warunek byÅ‚ speÅ‚niony dla przynajmniej jednego.

### ğŸ§© PrzykÅ‚ad:

ZnajdÅº ksiÄ…Å¼ki wydane wczeÅ›niej niÅ¼ wszystkie ksiÄ…Å¼ki Prusa.
```sql
SELECT tytul, rok
FROM Ksiazki
WHERE rok < ALL (
    SELECT rok
    FROM Ksiazki
    WHERE autor_id = (
        SELECT autor_id FROM Autorzy WHERE nazwisko = 'Prus'
    )
);
```

### ğŸ“˜ Opis dziaÅ‚ania:

- Podzapytanie wewnÄ™trzne zwraca lata publikacji ksiÄ…Å¼ek Prusa.
- Zapytanie gÅ‚Ã³wne wybiera tylko te ksiÄ…Å¼ki, ktÃ³rych rok jest mniejszy niÅ¼ wszystkie te wartoÅ›ci.



### ğŸ§® Podsumowanie typÃ³w podzapytaÅ„ w SQL

| **Typ podzapytania** | **Miejsce uÅ¼ycia** | **Zwracany wynik** | **Typowe operatory** | **PrzykÅ‚ad zastosowania** |
|------------------------|--------------------|--------------------|----------------------|----------------------------|
| **JednowartoÅ›ciowe (scalar)** | `WHERE`, `SELECT` | Pojedyncza wartoÅ›Ä‡ (1 rekord, 1 kolumna) | `=`, `<`, `>` | Autor o nazwisku â€Sienkiewiczâ€ |
| **WielowartoÅ›ciowe (multivalue)** | `WHERE` | Lista wartoÅ›ci (wiele rekordÃ³w) | `IN`, `NOT IN` | Autorzy, ktÃ³rych nazwisko zaczyna siÄ™ na â€Mâ€ |
| **Korelowane (correlated)** | `WHERE`, `SELECT` | Zmienny wynik dla kaÅ¼dego wiersza | `=`, `EXISTS` | Najstarsza ksiÄ…Å¼ka danego autora |
| **ZagnieÅ¼dÅ¼one w FROM (tabela pochodna)** | `FROM` | ZbiÃ³r wierszy (tymczasowa tabela) | â€” | Åšredni rok wydania ksiÄ…Å¼ek i porÃ³wnanie ze Å›redniÄ… |
| **Z operatorem EXISTS / NOT EXISTS** | `WHERE` | Prawda / FaÅ‚sz (czy istnieje wynik) | `EXISTS`, `NOT EXISTS` | Autorzy, ktÃ³rzy napisali przynajmniej jednÄ… ksiÄ…Å¼kÄ™ |
| **Z operatorem ALL / ANY / SOME** | `WHERE` | PorÃ³wnanie z wieloma wartoÅ›ciami | `ALL`, `ANY`, `SOME` | KsiÄ…Å¼ki starsze niÅ¼ wszystkie ksiÄ…Å¼ki Prusa |


## 4ï¸âƒ£ Widoki (Views)

### ğŸ”¹ Czym jest widok?

Widok (VIEW) to wirtualna tabela, ktÃ³ra prezentuje dane pochodzÄ…ce z jednej lub wielu tabel.
Widok nie przechowuje danych samodzielnie â€“ zawsze opiera siÄ™ na zapytaniu SQL.

PrzykÅ‚ad:
```sql
CREATE VIEW StudenciPelnoletni AS
SELECT Imie, Nazwisko, Wiek
FROM Studenci
WHERE Wiek >= 18;
```
â¡ï¸ Teraz moÅ¼na uÅ¼yÄ‡ widoku jak zwykÅ‚ej tabeli:
```sql
SELECT * FROM StudenciPelnoletni;
```
### ğŸ”¹ Zalety widokÃ³w

1.	Abstrakcja danych â€“ uÅ¼ytkownik nie musi znaÄ‡ zÅ‚oÅ¼onej struktury tabel.
2.	BezpieczeÅ„stwo â€“ moÅ¼na ograniczyÄ‡ dostÄ™p do wraÅ¼liwych kolumn.
3.	ReuÅ¼ywalnoÅ›Ä‡ â€“ skomplikowane zapytania moÅ¼na zapisaÄ‡ raz jako widok.
4.	Izolacja logiki â€“ zmiana struktury tabeli nie wymaga zmiany zapytaÅ„ uÅ¼ytkownikÃ³w.


### ğŸ”¹ Widoki z ograniczeniami (WITH CHECK OPTION)

JeÅ›li chcesz, aby przez widok moÅ¼na byÅ‚o wstawiaÄ‡ dane tylko zgodne z jego definicjÄ…, uÅ¼yj WITH CHECK OPTION.

```sql
CREATE VIEW StudenciMlodsi AS
SELECT * FROM Studenci
WHERE Wiek < 25
WITH CHECK OPTION;
```

â¡ï¸ PrÃ³ba wstawienia studenta starszego niÅ¼ 25 lat zakoÅ„czy siÄ™ bÅ‚Ä™dem:

```sql
INSERT INTO StudenciMlodsi VALUES (1234, 'Jan', 'Kowalski', 30);
-- ERROR: nie speÅ‚nia warunku widoku
```

### ğŸ”¹ Widoki w praktyce â€“ bezpieczeÅ„stwo danych

PrzykÅ‚ad ograniczenia dostÄ™pu do poufnych danych:

```sql
CREATE VIEW PracownicyPubliczni AS
SELECT Imie, Nazwisko, Dzial
FROM Pracownicy;
```
UÅ¼ytkownicy mogÄ… zobaczyÄ‡ tylko dane dziaÅ‚owe, ale nie np. pensje.

