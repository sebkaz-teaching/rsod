---
title: "Podstawy PL/SQL, transakcje i indeksy"
---

## ğŸ¯ Temat: Mechanizmy zapewniania spÃ³jnoÅ›ci danych i wprowadzenie do widokÃ³w

Celem wykÅ‚adu jest:

- poznanie zasad transakcyjnoÅ›ci i wÅ‚aÅ›ciwoÅ›ci ACID,
- zrozumienie wspÃ³Å‚bieÅ¼noÅ›ci i mechanizmÃ³w izolacji transakcji,
- zapoznanie siÄ™ z pojÄ™ciem widokÃ³w (views) i ich zastosowaniami,
- praktyczne zastosowanie transakcji i widokÃ³w w SQL / PL/SQL.

## 1ï¸âƒ£ Transakcje i ich wÅ‚aÅ›ciwoÅ›ci (ACID)

### ğŸ”¹ Co to jest transakcja?

Transakcja to logiczna jednostka pracy w bazie danych, skÅ‚adajÄ…ca siÄ™ z jednej lub wielu operacji (INSERT, UPDATE, DELETE, itp.), ktÃ³re powinny byÄ‡ wykonane caÅ‚oÅ›ciowo.

Transakcja to zbiÃ³r operacji, ktÃ³re albo wszystkie siÄ™ powiodÄ…, albo Å¼adna â€“ nie ma stanu poÅ›redniego.

PrzykÅ‚ad:
```sql
BEGIN;
UPDATE Konta SET Saldo = Saldo - 100 WHERE NrKonta = 101;
UPDATE Konta SET Saldo = Saldo + 100 WHERE NrKonta = 202;
COMMIT;
```

â¡ï¸ JeÅ›li obie aktualizacje siÄ™ powiodÄ… â€“ zmiany zostanÄ… zatwierdzone (COMMIT).

â¡ï¸ JeÅ›li jedna z operacji siÄ™ nie uda â€“ baza moÅ¼e przywrÃ³ciÄ‡ stan sprzed transakcji (ROLLBACK).


### ğŸ”¹ Operacje sterujÄ…ce transakcjÄ…

- BEGIN / START TRANSACTION â€“ rozpoczÄ™cie transakcji,
- COMMIT â€“ zatwierdzenie zmian,
- ROLLBACK â€“ cofniÄ™cie zmian do stanu poczÄ…tkowego,
- SAVEPOINT â€“ ustawienie punktu czÄ™Å›ciowego cofniÄ™cia.

```sql
BEGIN;
INSERT INTO Studenci VALUES (1001, 'Anna', 'Nowak', 22);
SAVEPOINT p1;
UPDATE Studenci SET Wiek = 23 WHERE NrIndeksu = 1001;
ROLLBACK TO SAVEPOINT p1;
COMMIT;
```
â¡ï¸ Zmieniono wiek Anny, ale cofniÄ™to tylko ostatniÄ… operacjÄ™ (ROLLBACK TO p1).

â¡ï¸ Wstawienie rekordu pozostaÅ‚o


## 2ï¸âƒ£ WspÃ³Å‚bieÅ¼noÅ›Ä‡ i problemy spÃ³jnoÅ›ci

### ğŸ”¹ Co to jest wspÃ³Å‚bieÅ¼noÅ›Ä‡?

WspÃ³Å‚bieÅ¼noÅ›Ä‡ (ang. concurrency) to sytuacja, gdy wiele transakcji wykonuje siÄ™ jednoczeÅ›nie na tej samej bazie danych.

DziÄ™ki wspÃ³Å‚bieÅ¼noÅ›ci baza moÅ¼e obsÅ‚ugiwaÄ‡ wielu uÅ¼ytkownikÃ³w naraz, aleâ€¦

â¡ï¸ moÅ¼e dojÅ›Ä‡ do konfliktÃ³w, jeÅ›li transakcje modyfikujÄ… te same dane.

### ğŸ”¹ PrzykÅ‚ad konfliktu wspÃ³Å‚bieÅ¼noÅ›ci

Transakcja 1
```sql
BEGIN;
UPDATE Konto SET Saldo = Saldo - 500 WHERE ID = 1;
```

Transakcja 2
```sql
BEGIN;
UPDATE Konto SET Saldo = Saldo - 300 WHERE ID = 1;

```

Obie modyfikujÄ… ten sam rekord.
JeÅ›li system nie zapewni izolacji â€” saldo koÅ„cowe moÅ¼e byÄ‡ bÅ‚Ä™dne.


## 3ï¸âƒ£ Poziomy izolacji transakcji

Bazy danych zapewniajÄ… rÃ³Å¼ne poziomy izolacji, ktÃ³re rÃ³wnowaÅ¼Ä… spÃ³jnoÅ›Ä‡ danych i wydajnoÅ›Ä‡.

### ğŸ”¹ PrzykÅ‚ad w PostgreSQL:

```sql
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM Zamowienia WHERE KlientID = 10;
-- Inna transakcja modyfikuje dane
SELECT * FROM Zamowienia WHERE KlientID = 10;
COMMIT;

```

â¡ï¸ Na poziomie REPEATABLE READ oba SELECT-y zobaczÄ… ten sam zestaw danych, nawet jeÅ›li inna transakcja je zmieniÅ‚a w miÄ™dzyczasie.

## 4ï¸âƒ£ Widoki (Views)

### ğŸ”¹ Czym jest widok?

Widok (VIEW) to wirtualna tabela, ktÃ³ra prezentuje dane pochodzÄ…ce z jednej lub wielu tabel.
Widok nie przechowuje danych samodzielnie â€“ zawsze opiera siÄ™ na zapytaniu SQL.

PrzykÅ‚ad:
```sql
CREATE VIEW StudenciPelnoletni AS
SELECT Imie, Nazwisko, Wiek
FROM Studenci
WHERE Wiek >= 18;
```
â¡ï¸ Teraz moÅ¼na uÅ¼yÄ‡ widoku jak zwykÅ‚ej tabeli:
```sql
SELECT * FROM StudenciPelnoletni;
```
### ğŸ”¹ Zalety widokÃ³w

1.	Abstrakcja danych â€“ uÅ¼ytkownik nie musi znaÄ‡ zÅ‚oÅ¼onej struktury tabel.
2.	BezpieczeÅ„stwo â€“ moÅ¼na ograniczyÄ‡ dostÄ™p do wraÅ¼liwych kolumn.
3.	ReuÅ¼ywalnoÅ›Ä‡ â€“ skomplikowane zapytania moÅ¼na zapisaÄ‡ raz jako widok.
4.	Izolacja logiki â€“ zmiana struktury tabeli nie wymaga zmiany zapytaÅ„ uÅ¼ytkownikÃ³w.


### ğŸ”¹ Widoki z ograniczeniami (WITH CHECK OPTION)

JeÅ›li chcesz, aby przez widok moÅ¼na byÅ‚o wstawiaÄ‡ dane tylko zgodne z jego definicjÄ…, uÅ¼yj WITH CHECK OPTION.

```sql
CREATE VIEW StudenciMlodsi AS
SELECT * FROM Studenci
WHERE Wiek < 25
WITH CHECK OPTION;
```

â¡ï¸ PrÃ³ba wstawienia studenta starszego niÅ¼ 25 lat zakoÅ„czy siÄ™ bÅ‚Ä™dem:

```sql
INSERT INTO StudenciMlodsi VALUES (1234, 'Jan', 'Kowalski', 30);
-- ERROR: nie speÅ‚nia warunku widoku
```

### ğŸ”¹ Widoki w praktyce â€“ bezpieczeÅ„stwo danych

PrzykÅ‚ad ograniczenia dostÄ™pu do poufnych danych:

```sql
CREATE VIEW PracownicyPubliczni AS
SELECT Imie, Nazwisko, Dzial
FROM Pracownicy;
```
UÅ¼ytkownicy mogÄ… zobaczyÄ‡ tylko dane dziaÅ‚owe, ale nie np. pensje.